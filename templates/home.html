<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <title>–ú–µ–º–∞—Ç–æ—Ä (AJAX)</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        /* --- –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∏–ª—å, —Ç—Ä–æ—Ö–∏ –ø—ñ–¥–ø—Ä–∞–≤–∏–≤ –¥–ª—è –¥–∏–Ω–∞–º—ñ–∫–∏ --- */
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #0f172a, #1e293b);
            color: #f1f5f9;
            min-height: 100vh;
        }
        header {
            padding: 20px;
            background: #1e293b;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            text-align: center;
            position: relative;
        }
        header h1 {
            margin: 0;
            font-size: 32px;
            color: #38bdf8;
            letter-spacing: 1px;
        }
        header p {
            margin-top: 5px;
            font-size: 15px;
            color: #94a3b8;
        }
        .search-box {
            display: flex;
            justify-content: center;
            margin: 20px auto;
            max-width: 760px;
            padding: 0 15px;
            gap: 10px;
        }
        .search-box form {
            display: flex;
            flex: 1;
            gap: 10px;
        }
        .search-box input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            outline: none;
            background: #0f172a;
            color: #f1f5f9;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.5);
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .search-box input:focus {
            box-shadow: 0 0 12px #38bdf8;
            transform: scale(1.02);
        }
        .search-box button {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            background: #38bdf8;
            color: #0f172a;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.25s, transform 0.2s;
        }
        .search-box button:hover {
            background: #0ea5e9;
            transform: scale(1.05);
        }

        .memes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .meme {
            background: #1e293b;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            transition: transform 0.3s, box-shadow 0.3s;
            animation: fadeIn 0.45s ease;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }
        .meme:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 10px 24px rgba(0,0,0,0.7);
        }
        .meme img {
            width: 100%;
            display: block;
            object-fit: cover;
            height: 180px;
        }
        .meme-title {
            padding: 12px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            color: #f8fafc;
            position: relative;
        }
        .meme-title a.download-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: #0f172a;
            background: #38bdf8;
            border-radius: 8px;
            padding: 2px 6px;
            text-decoration: none;
        }
        .meme-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            padding: 0 12px 12px;
        }
        .tag {
            background: #0ea5e9;
            color: #0f172a;
            font-size: 12px;
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 20px;
            cursor: pointer;
            user-select: none;
        }
        .empty {
            text-align: center;
            color: #94a3b8;
            font-size: 18px;
            margin-top: 40px;
            grid-column: 1/-1;
        }
        .loading {
            text-align: center;
            color: #94a3b8;
            font-size: 16px;
            margin: 10px 0 0;
            grid-column: 1/-1;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        @media (max-width: 600px) {
            .search-box form { flex-direction: column; }
            .search-box button { width: 100%; }
            .meme img { height: 140px; }
        }
    </style>
</head>
<body>
    <header>
        <h1><a href="/" style="text-decoration: none; color: inherit;">–ú–µ–º–∞—Ç–æ—Ä</a></h1>
        <p><b>–ú–µ–º–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ —ñ–º–µ–Ω—ñ –í–ª–∞–¥–∏—Å–ª–∞–≤–∞ –¢–æ–ø–æ—Ä–∫–æ–≤–∞</b></p>
        <a href="/admin" title="–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å"
            style="position:absolute; top:5px; right:5px; width:20px; height:20px; opacity:0; z-index:10;">.</a>
    </header>

    <div class="search-box">
        <form id="searchForm" autocomplete="off">
            <input id="searchInput" type="text" name="search" placeholder="–®—É–∫–∞—Ç–∏ –º–µ–º–∏ –∞–±–æ —Ç–µ–≥–∏ (–Ω–∞—Ç–∏—Å–Ω–∏ Enter)..." value="{{ query }}">
            <button type="submit">üîç –ó–Ω–∞–π—Ç–∏</button>
        </form>
    </div>

    <div id="memesContainer" class="memes" aria-live="polite">
        <!-- –º–µ–º–∏ –≤—Å—Ç–∞–≤–ª—è—é—Ç—å—Å—è —Å—é–¥–∏ JS-–æ–º -->
    </div>

    <script>
        (function () {
            const apiBase = '/api/get_memes'; // endpoint (–≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ ?query=...)
            const container = document.getElementById('memesContainer');
            const form = document.getElementById('searchForm');
            const input = document.getElementById('searchInput');

            let lastQuery = '';
            let debounceTimer = null;

            function renderMemes(list) {
                container.innerHTML = ''; // –æ—á–∏—Å—Ç–∏—Ç–∏
                if (!Array.isArray(list) || list.length === 0) {
                    const p = document.createElement('p');
                    p.className = 'empty';
                    p.textContent = '–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üòø';
                    container.appendChild(p);
                    return;
                }

                for (const m of list) {
                    const card = document.createElement('div');
                    card.className = 'meme';

                    const img = document.createElement('img');
                    img.src = m.url || (`/static/memes/${m.filename}`);
                    img.alt = m.title || m.filename || '';

                    const title = document.createElement('div');
                    title.className = 'meme-title';
                    title.textContent = m.title || m.filename || '';

                    const dl = document.createElement('a');
                    dl.className = 'download-btn';
                    dl.href = img.src;
                    dl.download = m.filename || '';
                    dl.title = '–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏';
                    dl.textContent = '‚§ì';
                    title.appendChild(dl);

                    card.appendChild(img);
                    card.appendChild(title);

                    if (m.tags && m.tags.length) {
                        const tagsWrap = document.createElement('div');
                        tagsWrap.className = 'meme-tags';
                        for (const t of m.tags) {
                            const span = document.createElement('span');
                            span.className = 'tag';
                            span.textContent = '#' + t;
                            // –∫–ª—ñ–∫ –ø–æ —Ç–µ–≥—É ‚Äî –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î –≤ —ñ–Ω–ø—É—Ç —ñ –∑–∞–ø—É—Å–∫–∞—î –ø–æ—à—É–∫
                            span.addEventListener('click', (ev) => {
                                ev.stopPropagation();
                                input.focus();
                                // –ø—ñ–¥—Å—Ç–∞–≤–∏–º–æ —Ç–µ–≥ –±–µ–∑ "#"
                                const plain = t;
                                input.value = plain;
                                triggerSearch();
                            });
                            tagsWrap.appendChild(span);
                        }
                        card.appendChild(tagsWrap);
                    }

                    // –∫–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç–æ—á—Ü—ñ ‚Äî –≤—ñ–¥–∫—Ä–∏–≤–∞—î –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –Ω–æ–≤–æ–º—É –≤—ñ–∫–Ω—ñ
                    card.addEventListener('click', () => {
                        window.open(img.src, '_blank');
                    });

                    container.appendChild(card);
                }
            }

            function showLoading() {
                container.innerHTML = '';
                const d = document.createElement('div');
                d.className = 'loading';
                d.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
                container.appendChild(d);
            }

            function fetchMemes(query = '') {
                // –≤–∏–±–∏—Ä–∞—î–º–æ —Ñ–æ—Ä–º√°t GET ?query=... (—Å–µ—Ä–≤–µ—Ä –º–∞—î –ø—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏)
                const url = apiBase + (query ? ('?query=' + encodeURIComponent(query)) : '');
                showLoading();
                return fetch(url, { credentials: 'same-origin' })
                    .then(res => {
                        if (!res.ok) throw new Error('HTTP ' + res.status);
                        return res.json();
                    })
                    .then(json => {
                        // –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –¥–≤–æ—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤: {"ok":true,"result":[...]} –∞–±–æ {"ok":true,"results":[...]}
                        const arr = (json && (json.result || json.results || json.data)) || [];
                        return arr;
                    })
                    .catch(err => {
                        console.error('fetchMemes error', err);
                        container.innerHTML = '';
                        const p = document.createElement('p');
                        p.className = 'empty';
                        p.textContent = '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –º–µ–º—ñ–≤.';
                        container.appendChild(p);
                        return [];
                    });
            }

            // —Ç—Ä–∏–≥–µ—Ä –ø–æ—à—É–∫—É (–≤–∏—Ä—ñ—à—É—î, —á–∏ —Ä–æ–±–∏—Ç–∏ –∑–∞–ø–∏—Ç)
            function triggerSearch() {
                const q = (input.value || '').trim();
                // —è–∫—â–æ –∑–∞–ø–∏—Ç —Ç–∞–∫–∏–π —Å–∞–º–∏–π —è–∫ –æ—Å—Ç–∞–Ω–Ω—ñ–π ‚Äî –Ω–µ —Ä–æ–±–∏—Ç–∏
                if (q === lastQuery) return;
                lastQuery = q;
                fetchMemes(q).then(list => renderMemes(list));
            }

            // debounce –ø—Ä–∏ –Ω–∞–±–æ—Ä—ñ
            input.addEventListener('input', () => {
                // –ü–†–û–ü–ò–°–ê–ù–û: –∫–æ–ª–∏ –≤–≤–æ–¥–∏—à –≤ –ø–æ–ª–µ ‚Äî —Ç–µ–≥–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö —Ö–æ–≤–∞—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
                const tags = document.querySelectorAll('.meme-tags');
                if (input.value.trim().length > 0) {
                    tags.forEach(t => t.style.display = 'none');
                } else {
                    tags.forEach(t => t.style.display = '');
                }

                if (debounceTimer) clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    triggerSearch();
                }, 300);
            });

            // —Å–∞–±–º—ñ—Ç (Enter –∞–±–æ –∫–Ω–æ–ø–∫–∞)
            form.addEventListener('submit', (ev) => {
                ev.preventDefault();
                if (debounceTimer) clearTimeout(debounceTimer);
                triggerSearch();
            });

            // initial load
            document.addEventListener('DOMContentLoaded', () => {
                // —è–∫—â–æ –≤ —à–∞–±–ª–æ–Ω—ñ —î –ø–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç ({{ query }}), –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ –π–æ–≥–æ
                const initial = (input.value || '').trim();
                lastQuery = initial;
                fetchMemes(initial).then(list => renderMemes(list));
            });

            // –∫–æ—Ä–∏—Å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –≤–∏–∫–ª–∏–∫—É
            window.Memator = {
                refresh: () => fetchMemes(input.value.trim()).then(l => renderMemes(l))
            };
        })();
    </script>
</body>
</html>
